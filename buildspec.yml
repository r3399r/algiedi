version: 0.2

env:
  variables:
    PROJECT: gotron
    ENV: dev
    DOMAIN: gotronmusic.com

phases:
  install:
    commands:
      - npm install
  build:
    commands:
      - npm run pre:deploy:backend
      - aws cloudformation package --template-file backend/aws/cloudformation/template.yaml --output-template-file packaged.yaml --s3-bucket gotron-cf-midway-ap-southeast-1
      - aws cloudformation deploy --template-file packaged.yaml --stack-name $PROJECT-$ENV-stack --parameter-overrides TargetEnvr=$ENV Project=$PROJECT Domain=$DOMAIN --no-fail-on-empty-changeset --s3-bucket gotron-cf-midway-ap-southeast-1 --capabilities CAPABILITY_NAMED_IAM
      - npm run pre:deploy:frontend
      - aws s3 sync ./dist s3://$PROJECT-$ENV --delete --cache-control no-cache

